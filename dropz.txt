// ==UserScript==
// @name         dropz
// @namespace    http://tampermonkey.net/
// @version      2024-08-28
// @description  try to take over the world!
// @author       You
// @match        https://my.dropz.xyz/member/*
// @match        https://googleads.g.doubleclick.net/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        GM_xmlhttpRequest
// @require      https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js
// ==/UserScript==

( function() {
    'use strict';
    setInterval(()=>{
     autoCaptcha();
    },5000);
    // Your code here...
    
/*
    setInterval(()=>{
     auto();
    },5000);

    setInterval(()=>{
     getCaptchaId();
    },5000);

    setInterval(()=>{
     getCaptchaResponse();
    },5000);

    setInterval(()=>{
     solveCaptcha();
    },5000);

	setInterval(()=>{
     clickOther();
    },5000);*/

})();
var idCaptcha = '';
 function autoCaptcha(){
    console.log("auto captcha");
    var base64 = '';
    if(document.querySelector('form img')){
        base64 = document.querySelector('form img').src;
    }
     if(base64 != ''){
         var ret =   Tesseract.recognize(base64,'eng');
         ret.then(function(data){ console.log(data.data.text);});
     }

    //.then(({ data: { text } })=>{console.log("Text from teseract:", text);});
}
function auto(){
    console.log("auto");
    var targetNode = document.querySelector("button[class='btn btn-info btn-sm mt-3 mb-4']");
    if (targetNode) {
        console.log(targetNode.innerText);

        if(targetNode.innerText.trim() === 'Visit Website'){
            console.log('click');
             clickButton("button[class='btn btn-info btn-sm mt-3 mb-4']");
			targetNode.scrollIntoView();
        }
    }
    else{
        console.log ("*** Target node not found!");
    }

    return;
    //setTimeout(auto(), 20000);
}

function getCaptchaId(){
    if(clickSolved){
		return;
	}
    var hcaptchaNode = document.querySelector("textarea[name='h-captcha-response']");
    if (hcaptchaNode){
        console.log('get captcha Id');
         if(idCaptcha === ''){
             console.log('send captcha id');
			 profile = 'PROFILE';
			 if(profile !== '')
				 GM_xmlhttpRequest({
					 method: "GET",
					 //url: "https://ocr.captchaai.com/in.php?key=85083ad522956ca65957407c945ed11d&method=hcaptcha&sitekey=5cb93c93-ed2d-4f52-bcbb-9a896cc6b071&pageurl=https://my.dropz.xyz/member/check-point?redirect=http%3A%2F%2Fmy.dropz.xyz%2Fmember%2Ftask%2Fsitefriends",
					 url:'http://localhost:8090/Captcha?profile=' + profile,
					 headers: {
						 "Content-Type": "application/json"
					 },
					 onload: function(response) {
						  console.log('send captcha id response ' + response.responseText);
						 var resText = response.responseText;

							idCaptcha = resText;
					 }
				 });
         }
    }
}


var hCaptchaResponse = '';
function getCaptchaResponse(){
    if(clickSolved){
		return;
	}
    console.log('id captcha = '+ idCaptcha);
    if(idCaptcha !== ''){
        console.log('get captcha response of id ' + idCaptcha);
        GM_xmlhttpRequest({
                 method: "GET",
                 //url: "https://ocr.captchaai.com/res.php?key=85083ad522956ca65957407c945ed11d&action=get&id=" + idCaptcha,
				 url:'http://localhost:8090/Response?captchaTask=' + idCaptcha,
                 headers: {
                     "Content-Type": "application/json"
                 },
                 onload: function(response) {
                      console.log('captcha response ' + response.responseText);
                     var resText = response.responseText;
                     if(resText === 'CAPTCHA_NOT_READY'){
                     }
                    else{
						hCaptchaResponse = resText;


                     }
                 }
             });
    }
}

var clickSolved = false;
var clickSolveTime = 0;
function solveCaptcha(){
    if(clickSolved && clickSolveTime > 2){
		return;
	}
     var hcaptchaNode = document.querySelector("textarea[name='h-captcha-response']");
    if (hcaptchaNode){
        console.log('solve captcha');
        if(hCaptchaResponse !== ''){
			document.querySelector("textarea[name='h-captcha-response']").style.display='block';
			document.querySelector("textarea[name='g-recaptcha-response']").style.display='block';
            document.querySelector("textarea[name='h-captcha-response']").value = hCaptchaResponse;
            document.querySelector("textarea[name='g-recaptcha-response']").value = hCaptchaResponse;

            clickSolved = true;
			clickSolveTime++;
            //document.querySelector("button[class='btn btn-block btn-danger text-light auth-form-btn']").click();
			clickButton("button[class='btn btn-block btn-danger text-light auth-form-btn']");
        }
    }
}

function clickOther(){
    clickButton("button[class='swal-button swal-button--confirm']");
    clickButton("div[id='dismiss-button']");
    

}
function clickButton(xpath){
     var targetNode = document.querySelector(xpath);
    if (targetNode) {
        targetNode.click();
           
    }
    else{

    }
}

function triggerMouseEvent (node, eventType) {
        var clickEvent = new Event(eventType, { bubbles: true, cancelable: true });
        node.dispatchEvent (clickEvent);
}

